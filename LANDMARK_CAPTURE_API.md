# API захвата достопримечательностей

## Обзор

Система позволяет игрокам захватывать достопримечательности. После захвата достопримечательность принадлежит игроку и его клану. Повторный захват возможен только через 1 час после предыдущего захвата.

## Модели

### Clan (Клан)
- `name` - название клана (уникальное)
- `description` - описание клана
- `created_at` - дата создания
- `created_by` - создатель клана

### CustomUser (обновлено)
- `clan` - связь с кланом (ForeignKey, nullable)

### LandmarkCapture
- `external_id` - ID достопримечательности из Wikipedia API
- `captured_by` - игрок, который захватил
- `clan` - клан игрока (может быть null)
- `captured_at` - время захвата

## API Endpoints

Все endpoints требуют аутентификации (JWT токен в заголовке `Authorization: Bearer <token>`).

### Метод 1: Получить информацию о захвате достопримечательности

**GET** `/api/landmarks/<external_id>/capture/`

Возвращает информацию о текущем владельце достопримечательности и можно ли её захватить сейчас.

**Response (200 - достопримечательность захвачена):**
```json
{
  "success": true,
  "captured": true,
  "can_capture_now": false,
  "captured_by": {
    "id": 5,
    "username": "player1"
  },
  "captured_at": "2024-01-01T12:00:00Z",
  "clan": {
    "id": 2,
    "name": "Awesome Clan"
  }
}
```

**Response (200 - достопримечательность никогда не захватывалась):**
```json
{
  "success": true,
  "captured": false,
  "can_capture_now": true,
  "captured_by": null,
  "captured_at": null,
  "clan": null
}
```

**Response (200 - достопримечательность можно захватить сейчас):**
```json
{
  "success": true,
  "captured": true,
  "can_capture_now": true,
  "captured_by": {
    "id": 5,
    "username": "player1"
  },
  "captured_at": "2024-01-01T11:00:00Z",
  "clan": {
    "id": 2,
    "name": "Awesome Clan"
  }
}
```

### Метод 2: Захватить достопримечательность

**POST** `/api/landmarks/capture/`

Захватывает достопримечательность (меняет владельца). Проверяет, можно ли захватить сейчас (через 1 час после предыдущего захвата).

**Request Body:**
```json
{
  "external_id": "12345"
}
```

**Response (201 - успешный захват):**
```json
{
  "success": true,
  "message": "Landmark captured successfully. Owner changed.",
  "capture": {
    "id": 1,
    "external_id": "12345",
    "captured_by": {
      "id": 6,
      "username": "player2"
    },
    "captured_at": "2024-01-01T13:00:00Z",
    "clan": {
      "id": 3,
      "name": "Cool Clan"
    }
  }
}
```

**Response (400 - нельзя захватить, не прошло достаточно времени):**
```json
{
  "success": false,
  "error": "Landmark cannot be captured now",
  "message": "Нельзя захватить достопримечательность сейчас. Повторный захват возможен через 45 мин 30 сек",
  "can_capture_now": false,
  "current_owner": {
    "id": 5,
    "username": "player1"
  },
  "captured_at": "2024-01-01T12:15:00Z",
  "time_until_next_capture_minutes": 45,
  "time_until_next_capture_seconds": 30
}
```

## Логика работы

### Метод 1: Получение информации о захвате
- Возвращает информацию о текущем владельце достопримечательности (кто захватил, когда, какой клан)
- Возвращает булевое значение `can_capture_now`:
  - `true` - если достопримечательность еще не захватывалась ИЛИ прошло 1+ час с последнего захвата
  - `false` - если прошло меньше 1 часа с последнего захвата

### Метод 2: Захват достопримечательности
1. **Проверка возможности захвата:**
   - Проверяет `can_capture_now` через метод `LandmarkCapture.can_capture()`
   - Если `can_capture_now = false` - возвращает ошибку с информацией о текущем владельце и времени до следующего возможного захвата

2. **Первый захват:**
   - Если достопримечательность еще никто не захватывал - создается новая запись `LandmarkCapture`
   - Владелец становится текущий игрок

3. **Повторный захват (смена владельца):**
   - Если прошло 1+ час с последнего захвата - создается новая запись `LandmarkCapture`
   - Владелец меняется на текущего игрока
   - Старые записи остаются в истории (для истории захватов)

4. **Проверка времени:**
   - Используется `timedelta(hours=1)` для проверки
   - Новый захват возможен только через 1 час после предыдущего

## Установка и применение миграций

После реализации необходимо создать и применить миграции:

```bash
# Создать миграции для accounts (Clan, поле clan в CustomUser)
python manage.py makemigrations accounts

# Создать миграции для landmarks (LandmarkCapture)
python manage.py makemigrations landmarks

# Применить все миграции
python manage.py migrate
```

## Примечания

- Игрок может быть без клана (`clan = null`). В этом случае захват будет сохранен без клана
- Логика кланов (создание, присоединение) будет добавлена позже
- Все захваты хранятся в истории (старые записи не удаляются автоматически)
- Для определения "текущего" владельца используется последний захват по времени

